#!/bin/bash

THIS=$(realpath "$0")
HERE=$(dirname "${THIS}") 

function upload {
  virsh vol-create-as --pool "${POOL}" --name "$2" --capacity 1g
  virsh vol-upload --pool "${POOL}" --vol "$2" --file "$1"
  virsh vol-list --pool "${POOL}"
}

function make_primary_disk {
  DISK="${IMAGES}/${PRIMARY}"
  truncate --size=${ROOT_SIZE} "${DISK}"
  virt-resize --quiet --expand "${ROOT_DEVICE}" "${IMAGES}/${IMAGE}" "${DISK}"
  upload "${DISK}" "${PRIMARY}"
}

function make_cloud_init {
  TEMP=$(mktemp --directory)
  CI_USER="${TEMP}/user-data"
  CI_META="${TEMP}/meta-data"
  CI_NETWORK="${TEMP}/network-config"
  envsubst < "${HERE}/cloud-init/user-data"             > "${CI_USER}"
  envsubst < "${HERE}/cloud-init/meta-data"             > "${CI_META}"
  envsubst < "${HERE}/cloud-init/network-config-static" > "${CI_NETWORK}"
}

function make_vm {
  virt-install \
    --import \
    --virt-type kvm \
    --osinfo "${OS}" \
    --name "${HOST}" \
    --memory "${MEMORY}" \
    --vcpus "${CPUS}" \
    --disk=vol=${POOL}/${PRIMARY},device=disk \
    --cloud-init=user-data=${CI_USER},meta-data=${CI_META},network-config=${CI_NETWORK} \
    --network "${NETWORK}" \
    --graphics none \
    --noautoconsole
}

IMAGES="${HERE}/images"
PRIMARY="${HOST}.qcow2"

make_primary_disk
make_cloud_init
make_vm

rm "${DISK}"

# rm -rf "${TEMP}"
